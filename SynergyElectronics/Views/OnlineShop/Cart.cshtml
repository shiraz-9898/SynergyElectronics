@{
    ViewData["Title"] = "Cart";
}

<style>

    #ag {
        height: 600px;
        margin-top: 70px;
    }
    #mainBody{
        height: 80vh;
    }
    
    .ag-center-cols-viewport {
        min-height: unset !important;
    }
    .ag-theme-quartz-dark {
        --ag-header-height: 50px;
        font-size: 18px;
        /* bright green, 10% opacity */
        --ag-selected-row-background-color: rgb(0, 255, 0, 0.1);
    }

        .ag-theme-quartz-dark .ag-header {
            background-color: #7C9D96;
        }

    .ag-paging-panel {
        background-color: #7C9D96;
        color: white;
        height: 60px;
    }

    .ag-theme-quartz-dark .ag-header-cell-label {
        font-size: 20px;
        color: white;
    }

    .ag-icon-filter, .ag-icon-menu {
        color: white;
    }

    .btnColor {
        background-color: #FFCC70;
        margin-top: 30px;
        padding: 7px 20px;
        border-radius: 10px;
    }

    .divForm {
        background-color: #7C9D96;
        border: 1px solid black;
        border-radius: 5px;
    }

        .divForm label {
            color: white;
        }
        .total{
            max-width: 60%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: auto;
            padding: 10px;
        }
</style>


<div id="mainBody">
    <div id="ag" class="container ag-theme-quartz-dark"></div>
    <div class="total">
        <h3>Total Amount : Rs <strong id="amount">0</strong></h3>
        <a class="btn btn-primary" asp-action="PaymentPage" id="payBtn">Proceed to Payment <span class="glyphicon glyphicon-menu-right"></span></a>
    </div>
</div>


<script>
    
    const gridOptions = {
        defaultColDef: {
        },

        columnDefs: [            
            {
                field: "isSelected", headerName: "", width: "20", editable: true, 
            },
            {
                field: "products.prod_Name", headerName: "Product", width: "750", 
            },
            { field: "cart_Price", headerName: "Amount", width: "150", valueFormatter: function (params) { return "Rs. " + params.value.toLocaleString(); } },
            {
                field: "cart_Qty",
                headerName: "Qty",
                // cellRenderer: function (x) {
                //     var data = x.data;
                //     return `<select id = "myQty"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>`;
                // },
                editable: true,
                width: "90",
                
            },
            {
                headerName: "Action",
                width: "90",
                cellRenderer: function (x) {
                    var data = x.data;                    
                    return `<button class="btn btn-danger" onclick = "deleteData(${data.cart_Id})"><span class="glyphicon glyphicon-trash"></span></button>`
                },
            },
        ],

        rowSelection: 'multiple',
        
        onCellValueChanged: (event) => {
            // fetch(`/OnlineShop/Edit/`, {
            //     method: "POST",
            //     headers: {
            //         "content-type": "application/json",
            //     },
            //     body: JSON.stringify(event.data),
            // })

            $.ajax({
                type: "POST",
                url: "/OnlineShop/Edit/",
                data: event.data,
                success: function (data) {
                    var total = 0;
                    data.forEach(function (item) {                        
                        if (item.isSelected) {
                            total += item.cart_Price;
                        }                        
                    });
                    $("#amount").text(total.toLocaleString());
                    return gridApi.setGridOption('rowData', data);
                },
                error: function (data) {
                    alert(data);
                }
            })
        },
    };

    const AG = document.querySelector("#ag");
    const gridApi = agGrid.createGrid(AG, gridOptions);
    
    $.ajax({
        type: "Get",
        url: "/OnlineShop/GetCartData/", 
        success: function (data) {         
            var total = 0;
            data.forEach(function (item) {
                if (item.isSelected) {
                    total += item.cart_Price;
                }
            });
            $("#amount").text(total.toLocaleString());
            return gridApi.setGridOption('rowData', data);
        },
        error: function (data) {
            alert(data);
        }
    })

    function deleteData(id) {
        fetch(`/OnlineShop/Delete/${id}`, { method: "POST" })
            .then((response) => response.json())
            .then(function (data) {
                var total = 0;
                data.forEach(function (item) {
                    if (item.isSelected) {
                        total += item.cart_Price;
                    }
                });
                $("#amount").text(total.toLocaleString());
                return gridApi.setGridOption('rowData', data);
            });

    }

    $("#payBtn").on("click", function (e) {
        // e.preventDefault();
        var dataObject = gridApi.rowModel.nodeManager.allNodesMap;
        console.log(dataObject);
        var flag = true;

        for (var item in dataObject) {
            if (dataObject[item].data.isSelected) {
                flag = false;
            }
        }
        console.log(flag);
        if (flag) {
            console.log("flag");
            e.preventDefault();
            alert("Please select atleast one product to proceed to payment.");
        }
        console.log("after if");
        
    })

</script>
